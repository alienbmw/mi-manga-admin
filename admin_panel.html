<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración de Web Manga</title>
    <!-- Incluyendo Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .ai-button {
            transition: all 0.15s ease-in-out;
            background-color: #3b82f6; /* Blue 500 */
        }
        .ai-button:hover:not(:disabled) {
            background-color: #2563eb; /* Blue 600 */
        }
        .ai-button:disabled {
            background-color: #93c5fd; /* Blue 300 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Gestión de Contenido (Admin)</h1>

        <!-- Mensajes de Estado (Éxito/Error) -->
        <div id="status-message" class="hidden p-4 rounded-lg mb-6 transition duration-300"></div>

        <!-- Vista de Login -->
        <div id="login-view" class="max-w-md mx-auto bg-white p-8 rounded-xl container-card">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Iniciar Sesión de Administrador</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="secret_key" class="block text-sm font-medium text-gray-700 mb-2">Clave Secreta de Admin</label>
                    <input type="password" id="secret_key" name="secret_key" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">
                    Acceder
                </button>
            </form>
        </div>

        <!-- Vista del Panel de Control -->
        <div id="admin-view" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Columna de Creación de Manga -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl container-card h-fit">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-700">Crear Nuevo Manga</h2>
                    <form id="create-manga-form">
                        <div class="mb-4">
                            <label for="titulo" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                            <input type="text" id="titulo" name="titulo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-4">
                            <label for="autor" class="block text-sm font-medium text-gray-700 mb-1">Autor</label>
                            <input type="text" id="autor" name="autor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-2">
                            <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                            <textarea id="descripcion" name="descripcion" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <!-- Botón de Generación por IA -->
                        <button type="button" id="generate-description-button" class="ai-button w-full text-white py-2 rounded-lg font-semibold mb-6">
                            Generar Descripción ✨
                        </button>

                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150">
                            Publicar Manga
                        </button>
                    </form>
                </div>
                
                <!-- Columna de Listado de Mangas -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl container-card">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-700 flex justify-between items-center">
                        Lista de Mangas Publicados
                        <button id="refresh-button" class="text-sm px-3 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                            Recargar
                        </button>
                    </h2>
                    
                    <div id="manga-list" class="space-y-4">
                        <p class="text-center text-gray-500">Cargando mangas...</p>
                    </div>

                    <div id="pagination-controls" class="mt-6 flex justify-center space-x-4 hidden">
                        <!-- Aquí iría la lógica de paginación -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL de la API de Flask (debe coincidir con la dirección donde ejecutas app.py)
        const API_URL = 'http://127.0.0.1:5000/api';
        
        // Configuración de la API de Gemini (LLM)
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        const apiKey = ""; // La clave API es gestionada por el entorno de Canvas

        let adminToken = localStorage.getItem('adminToken') || null;

        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const loginForm = document.getElementById('login-form');
        const createMangaForm = document.getElementById('create-manga-form');
        const mangaList = document.getElementById('manga-list');
        const statusMessage = document.getElementById('status-message');
        const refreshButton = document.getElementById('refresh-button');
        const generateDescriptionButton = document.getElementById('generate-description-button');
        const descripcionTextarea = document.getElementById('descripcion');

        // ==================================================
        // Funciones de Utilidad
        // ==================================================

        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = 'p-4 rounded-lg mb-6 transition duration-300';
            statusMessage.classList.remove('hidden');

            if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            }

            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

        function checkAuth() {
            if (adminToken) {
                loginView.classList.add('hidden');
                adminView.classList.remove('hidden');
                fetchMangas();
            } else {
                loginView.classList.remove('hidden');
                adminView.classList.add('hidden');
            }
        }

        // ==================================================
        // Manejo de Eventos y Lógica Principal
        // ==================================================

        // 1. Manejo del Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const secretKey = document.getElementById('secret_key').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secret_key: secretKey })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    checkAuth();
                    showStatus("¡Bienvenido, administrador!", "success");
                } else {
                    showStatus(data.message || "Error de autenticación.", "error");
                }
            } catch (error) {
                showStatus("Error de red al intentar iniciar sesión.", "error");
            }
        });

        // 2. Obtener y Mostrar Mangas
        async function fetchMangas() {
            mangaList.innerHTML = '<p class="text-center text-gray-500">Cargando mangas...</p>';
            try {
                // Endpoint público para la lista
                const response = await fetch(`${API_URL}/mangas`); 
                const mangas = await response.json();

                if (!response.ok) {
                    throw new Error(mangas.error || "Error al obtener la lista de mangas.");
                }

                if (mangas.length === 0) {
                    mangaList.innerHTML = '<p class="text-center text-gray-500">Aún no hay mangas publicados.</p>';
                    return;
                }

                mangaList.innerHTML = ''; // Limpiar lista
                mangas.forEach(manga => {
                    const mangaItem = document.createElement('div');
                    mangaItem.className = 'flex justify-between items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50';
                    mangaItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${manga.titulo} (ID: ${manga.id})</p>
                            <p class="text-sm text-gray-500">Autor: ${manga.autor || 'Desconocido'}</p>
                        </div>
                        <button onclick="deleteManga(${manga.id})" class="text-red-600 hover:text-red-800 transition duration-150 p-2 rounded-full hover:bg-red-100">
                            <!-- Icono de basura (lucide-react, simulado con SVG para un solo archivo) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    `;
                    mangaList.appendChild(mangaItem);
                });

            } catch (error) {
                mangaList.innerHTML = `<p class="text-center text-red-500">Error: ${error.message}</p>`;
                console.error("Fetch Error:", error);
            }
        }

        refreshButton.addEventListener('click', fetchMangas);

        // 3. Crear Nuevo Manga
        createMangaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!adminToken) {
                showStatus("Debes iniciar sesión para crear contenido.", "error");
                return;
            }

            const formData = new FormData(createMangaForm);
            const newManga = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_URL}/mangas`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}` // Envío del token
                    },
                    body: JSON.stringify(newManga)
                });

                const data = await response.json();

                if (response.ok && response.status === 201) {
                    showStatus(`Manga '${data.titulo}' creado con éxito! ID: ${data.id}`, "success");
                    createMangaForm.reset();
                    fetchMangas(); // Recargar la lista
                } else {
                    showStatus(`Error al crear: ${data.error || data.message || "Error desconocido."}`, "error");
                }
            } catch (error) {
                showStatus("Error de red al crear el manga.", "error");
                console.error("Create Error:", error);
            }
        });

        // 4. Eliminar Manga
        window.deleteManga = async (id) => {
            if (!adminToken) {
                showStatus("Debes iniciar sesión para eliminar contenido.", "error");
                return;
            }

            // Uso de modal de confirmación simple (reemplaza 'confirm' en un entorno de producción)
            if (confirm(`¿Estás seguro de que quieres eliminar el Manga con ID ${id}?`)) {
                try {
                    const response = await fetch(`${API_URL}/mangas/${id}`, {
                        method: 'DELETE',
                        headers: { 
                            'Authorization': `Bearer ${adminToken}` // Envío del token
                        }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showStatus(data.message, "success");
                        fetchMangas(); // Recargar la lista
                    } else {
                        showStatus(`Error al eliminar: ${data.message || "Error desconocido."}`, "error");
                    }
                } catch (error) {
                    showStatus("Error de red al intentar eliminar el manga.", "error");
                    console.error("Delete Error:", error);
                }
            }
        };

        // 5. Generar Descripción con Gemini (NUEVA FUNCIONALIDAD)
        async function generateDescription() {
            const title = document.getElementById('titulo').value.trim();
            const author = document.getElementById('autor').value.trim();

            if (!title) {
                showStatus("Por favor, ingresa un título para generar la descripción.", "error");
                return;
            }

            // Mostrar estado de carga y deshabilitar botón
            generateDescriptionButton.disabled = true;
            generateDescriptionButton.textContent = 'Generando...';

            const systemPrompt = "Eres un asistente creativo de edición de manga. Genera una descripción atractiva y concisa para el siguiente manga. La descripción debe tener un tono épico, misterioso o divertido (según el título) y debe ser adecuada para una sinopsis de sitio web, de no más de 100 palabras. Usa lenguaje que atraiga a los lectores.";
            const userQuery = `Título del Manga: "${title}". Autor: ${author || 'No especificado'}. Genera una sinopsis emocionante.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                // Implementación de Backoff Exponencial para la llamada a la API
                const maxRetries = 3;
                let attempt = 0;
                let response = null;

                while (attempt < maxRetries) {
                    try {
                        response = await fetch(GEMINI_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status !== 429) { // No es un error de rate limit
                            break; 
                        }
                        
                        // Si es 429, espera exponencialmente antes de reintentar
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempt++;

                    } catch (err) {
                        // Errores de red
                        throw err;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`Fallo en la API de Gemini después de ${maxRetries} intentos.`);
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    descripcionTextarea.value = generatedText.trim();
                    showStatus("Descripción generada con éxito por Gemini.", "success");
                } else {
                    throw new Error("Respuesta de Gemini inválida o vacía.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                showStatus("Error al generar la descripción con IA. Inténtalo de nuevo.", "error");
            } finally {
                generateDescriptionButton.disabled = false;
                generateDescriptionButton.textContent = 'Generar Descripción ✨';
            }
        }

        generateDescriptionButton.addEventListener('click', generateDescription);


        // Inicializar la aplicación al cargar
        document.addEventListener('DOMContentLoaded', checkAuth);

    </script>
</body>
</html>
